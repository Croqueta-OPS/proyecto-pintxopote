{"filter":false,"title":"passport.js","tooltip":"/config/passport.js","undoManager":{"mark":100,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":30,"column":11},"end":{"row":30,"column":12},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":12},"end":{"row":30,"column":13},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":13},"end":{"row":30,"column":14},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":14},"end":{"row":30,"column":15},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":15},"end":{"row":30,"column":16},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":16},"end":{"row":30,"column":17},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":17},"end":{"row":30,"column":18},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":18},"end":{"row":30,"column":19},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":19},"end":{"row":30,"column":20},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":14},"end":{"row":34,"column":15},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":15},"end":{"row":34,"column":16},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":16},"end":{"row":34,"column":17},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":17},"end":{"row":34,"column":18},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":18},"end":{"row":34,"column":19},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":8},"end":{"row":34,"column":9},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":7},"end":{"row":34,"column":8},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":8},"end":{"row":38,"column":9},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":7},"end":{"row":38,"column":8},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":12},"end":{"row":34,"column":13},"action":"insert","lines":["!"]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":7},"end":{"row":42,"column":11},"action":"remove","lines":[" else {","            Admin.findById(id, function(err, user) {","                done(err, user);","            });","        //}"]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":19},"end":{"row":34,"column":20},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":20},"end":{"row":34,"column":21},"action":"insert","lines":["{"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":15},"end":{"row":38,"column":0},"action":"insert","lines":["",""]},{"start":{"row":38,"column":0},"end":{"row":38,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":12},"end":{"row":38,"column":13},"action":"insert","lines":["}"]},{"start":{"row":38,"column":0},"end":{"row":38,"column":12},"action":"remove","lines":["            "]},{"start":{"row":38,"column":0},"end":{"row":38,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":8},"end":{"row":33,"column":24},"action":"remove","lines":["console.log(id);"]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":48},"end":{"row":29,"column":49},"action":"remove","lines":["{"]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":48},"end":{"row":29,"column":49},"action":"insert","lines":["´"]},{"start":{"row":29,"column":49},"end":{"row":29,"column":50},"action":"insert","lines":["{"]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":48},"end":{"row":29,"column":49},"action":"remove","lines":["´"]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":49},"end":{"row":30,"column":0},"action":"insert","lines":["",""]},{"start":{"row":30,"column":0},"end":{"row":30,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":12},"end":{"row":35,"column":13},"action":"remove","lines":["!"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":17},"end":{"row":35,"column":18},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":18},"end":{"row":35,"column":19},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":19},"end":{"row":35,"column":20},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":20},"end":{"row":35,"column":21},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":21},"end":{"row":35,"column":22},"action":"insert","lines":["b"]},{"start":{"row":35,"column":22},"end":{"row":35,"column":23},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":23},"end":{"row":35,"column":24},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":23},"end":{"row":35,"column":24},"action":"remove","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":22},"end":{"row":35,"column":23},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":21},"end":{"row":35,"column":22},"action":"remove","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":21},"end":{"row":35,"column":22},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":22},"end":{"row":35,"column":23},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":23},"end":{"row":35,"column":24},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":24},"end":{"row":35,"column":25},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":18},"end":{"row":35,"column":19},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":19},"end":{"row":31,"column":20},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":18},"end":{"row":31,"column":19},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":17},"end":{"row":31,"column":18},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":16},"end":{"row":31,"column":17},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":15},"end":{"row":31,"column":16},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":14},"end":{"row":31,"column":15},"action":"remove","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":13},"end":{"row":31,"column":14},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":12},"end":{"row":31,"column":13},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":11},"end":{"row":31,"column":12},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":10},"end":{"row":31,"column":11},"action":"remove","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":9},"end":{"row":31,"column":10},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":8},"end":{"row":31,"column":9},"action":"remove","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":0},"end":{"row":40,"column":0},"action":"remove","lines":["        if (admin === null) {","            User.findById(id, function(err, user) {","                done(err, user);","            });","        }",""]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":48},"end":{"row":32,"column":0},"action":"insert","lines":["",""]},{"start":{"row":32,"column":0},"end":{"row":32,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":12},"end":{"row":37,"column":0},"action":"insert","lines":["        if (admin === null) {","            User.findById(id, function(err, user) {","                done(err, user);","            });","        }",""]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":0},"end":{"row":32,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":0},"end":{"row":32,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":0},"end":{"row":33,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":19},"end":{"row":32,"column":20},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":18},"end":{"row":32,"column":19},"action":"remove","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":17},"end":{"row":32,"column":18},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":16},"end":{"row":32,"column":17},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":16},"end":{"row":32,"column":17},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":17},"end":{"row":32,"column":18},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":18},"end":{"row":32,"column":19},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":19},"end":{"row":32,"column":20},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":20},"end":{"row":32,"column":21},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":32,"column":16},"end":{"row":32,"column":17},"action":"insert","lines":["!"]}]}],[{"group":"doc","deltas":[{"start":{"row":36,"column":8},"end":{"row":36,"column":12},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":35,"column":12},"end":{"row":35,"column":16},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":15},"end":{"row":34,"column":16},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":16},"end":{"row":34,"column":17},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":34,"column":16},"end":{"row":34,"column":20},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":36,"column":13},"end":{"row":37,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":36,"column":13},"end":{"row":37,"column":0},"action":"insert","lines":["",""]},{"start":{"row":37,"column":0},"end":{"row":37,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":12},"end":{"row":37,"column":13},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":13},"end":{"row":37,"column":14},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":14},"end":{"row":37,"column":15},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":15},"end":{"row":37,"column":16},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":16},"end":{"row":37,"column":17},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":17},"end":{"row":37,"column":18},"action":"insert","lines":["{"]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":28},"end":{"row":39,"column":0},"action":"insert","lines":["",""]},{"start":{"row":39,"column":0},"end":{"row":39,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":39,"column":12},"end":{"row":39,"column":13},"action":"insert","lines":["}"]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":12},"end":{"row":38,"column":16},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":49},"end":{"row":23,"column":15},"action":"remove","lines":["","               "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":49},"end":{"row":23,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":11},"end":{"row":39,"column":8},"action":"remove","lines":["","        "]}]}],[{"group":"doc","deltas":[{"start":{"row":38,"column":11},"end":{"row":39,"column":7},"action":"remove","lines":["","       "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":175,"column":2},"action":"remove","lines":["// config/passport.js","","// Declaramos la estragia que vamos a seguir. En este caso logeamos desde local.","var LocalStrategy   = require('passport-local').Strategy;","","// Requerimos el tipo de modelo que vamos a usar","var User       \t\t= require('../app/models/user');","","var Admin           = require('../app/models/admin');","","","","// Exponemos esta función a nuestra aplicación con module.exports","module.exports = function(passport) {","","    // =========================================================================","    // Configuración de passport session =======================================","    // =========================================================================","    // required for persistent login sessions","    // passport necesita habilitar el serializar o deserializar usuarios por sesión","","    // Se usa para serializar al usuario por sesión","    passport.serializeUser(function(user, done) {","        done(null, user.id);","    });","","    // utilizado para deserializar","    passport.deserializeUser(function(id, done) {","        ","        Admin.findById(id, function(err, user) {","            if (!user) {","                User.findById(id, function(err, user) {","                    done(err, user);","                });","            }","            else {","                done(err, user);","            }","        });","        ","    });","","    //-------------------------","     // ========================================================================","    // LOCAL LOGIN =============================================================","    // =========================================================================","    // we are using named strategies since we have one for login and one for signup","    // by default, if there was no name, it would just be called 'local'","","    passport.use('local-login', new LocalStrategy({","        // by default, local strategy uses username and password, we will override with email","        usernameField : 'email',","        passwordField : 'password',","        passReqToCallback : true // allows us to pass back the entire request to the callback","    },","    function(req, email, password, done) { // callback with email and password from our form","","        // find a user whose email is the same as the forms email","        // we are checking to see if the user trying to login already exists","        User.findOne({ 'local.email' :  email }, function(err, user) {","            // if there are any errors, return the error before anything else","            if (err)","                return done(err);","","            // if no user is found, return the message","            if (!user)","                return done(null, false, req.flash('loginMessage', 'No existe el usuario.')); // req.flash is the way to set flashdata using connect-flash","","            // if the user is found but the password is wrong","            if (!user.validPassword(password))","                return done(null, false, req.flash('loginMessage', 'Oops! Password incorrecto.')); // create the loginMessage and save it to session as flashdata","","            // all is well, return successful user","            return done(null, user);","        });","","    }));","    ","    //-------------------------","    // ========================================================================","    // Borrar si no funciona =============================================================    ","    passport.use('local-admin', new LocalStrategy({","        // by default, local strategy uses username and password, we will override with email","        usernameField : 'username',","        passwordField : 'passwordAdmin',","        passReqToCallback : true // allows us to pass back the entire request to the callback","    },","    function(req, username, passwordAdmin, done) { // callback with email and password from our form","        // find a user whose email is the same as the forms email","        // we are checking to see if the user trying to login already exists","        Admin.findOne({ 'username' :  username }, function(err, admin) {","            // if there are any errors, return the error before anything else","            if (err) {","                return done(err);","            }","            // if no user is found, return the message","            if (!admin) {","                return done(null, false, req.flash('loginMessage', 'No existe el usuario.')); // req.flash is the way to set flashdata using connect-flash","            }","            // if the user is found but the password is wrong","            if (!admin.validPassword(passwordAdmin)) {","                return done(null, false, req.flash('loginMessage', 'Oops! Password incorrecto.')); // create the loginMessage and save it to session as flashdata","            }","            // all is well, return successful user","            return done(null, admin);","        });","    }));","//-------------------------","","//-------------------------"," \t// =========================================================================","    // LOCAL SIGNUP ============================================================","    // =========================================================================","    // we are using named strategies since we have one for login and one for signup","\t// by default, if there was no name, it would just be called 'local'","","    passport.use('local-signup', new LocalStrategy({","        // by default, local strategy uses username and password, we will override with email","        usernameField : 'email',","        passwordField : 'password',","        passReqToCallback : true, // allows us to pass back the entire request to the callback","    },","    function(req, email, password, done) {","","        // asynchronous","        // User.findOne wont fire unless data is sent back","        process.nextTick (function() {","","\t\t// find a user whose email is the same as the forms email","\t\t// we are checking to see if the user trying to login already exists","        ","        User.findOne({ 'local.nomUsuario' :  req.body.username }, function(err, user) {","            // if there are any errors, return the error","            if (err)","                return done(err);","            // check to see if theres already a user with that email","            if (user) {","                return done(null, false, req.flash('signupMessage', 'Ese usuario está cogido.'));","            } else {","","                User.findOne({'local.email' : email}, function(err, user){","                    // if there are any errors, return the error","                    if (err)","                        return done(err);","        ","                    // check to see if theres already a user with that email","                    if (user) {","                        return done(null, false, req.flash('signupMessage', 'Ese email está cogido.'));","                    }else{","                        // if there is no user with that email","                        // create the user","                        var newUser = new User();","        ","                        // set the user's local credentials","                        newUser.local.email = email;","                        newUser.local.password = newUser.generateHash(password);","                        newUser.local.nomUsuario = req.body.username;","                        newUser.local.sexo = req.body.gender;","                        newUser.local.fechaNac = req.body.birthday;","        ","        ","        \t\t\t\t// save the user","                        newUser.save (function(err) {","                            if (err)","                                throw err;","                            return done (null, newUser);","                        });","                    }","                });","    ","            }","","        });","    });","}));","};"]}]}]]},"ace":{"folds":[],"scrolltop":2761.5,"scrollleft":0,"selection":{"start":{"row":172,"column":8},"end":{"row":172,"column":8},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":158,"state":"start","mode":"ace/mode/javascript"}},"hash":"b10a77ed30fbea6ad55d8cd61f1d4369d34f03df"}